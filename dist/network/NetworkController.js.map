{"version":3,"file":"NetworkController.js","sourceRoot":"","sources":["../../src/network/NetworkController.ts"],"names":[],"mappings":"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","sourcesContent":["import BaseController, { BaseConfig, BaseState } from '../BaseController';\n\nconst EthQuery = require('eth-query');\nconst Subprovider = require('web3-provider-engine/subproviders/provider.js');\nconst createInfuraProvider = require('eth-json-rpc-infura/src/createProvider');\nconst createMetamaskProvider = require('web3-provider-engine//zero.js');\nconst { Mutex } = require('await-semaphore');\n\n/**\n * Human-readable network name\n */\nexport type NetworkType = 'kovan' | 'localhost' | 'mainnet' | 'rinkeby' | 'goerli' | 'ropsten' | 'rpc';\n\nexport enum NetworksChainId {\n  mainnet = '1',\n  kovan = '42',\n  rinkeby = '4',\n  goerli = '5',\n  ropsten = '3',\n  localhost = '',\n  rpc = '',\n}\n\n/**\n * @type ProviderConfig\n *\n * Configuration passed to web3-provider-engine\n *\n * @param rpcTarget? - RPC target URL\n * @param type - Human-readable network name\n * @param chainId? - Network ID as per EIP-155\n * @param ticker? - Currency ticker\n * @param nickname? - Personalized network name\n */\nexport interface ProviderConfig {\n  rpcTarget?: string;\n  type: NetworkType;\n  chainId: string;\n  ticker?: string;\n  nickname?: string;\n}\n\n/**\n * @type NetworkConfig\n *\n * Network controller configuration\n *\n * @property infuraProjectId - an Infura project ID\n * @property providerConfig - web3-provider-engine configuration\n */\nexport interface NetworkConfig extends BaseConfig {\n  infuraProjectId?: string;\n  providerConfig: ProviderConfig;\n}\n\n/**\n * @type NetworkState\n *\n * Network controller state\n *\n * @property network - Network ID as per net_version\n * @property provider - RPC URL and network name provider settings\n */\nexport interface NetworkState extends BaseState {\n  network: string;\n  provider: ProviderConfig;\n}\n\nconst LOCALHOST_RPC_URL = 'http://localhost:8545';\n\n/**\n * Controller that creates and manages an Ethereum network provider\n */\nexport class NetworkController extends BaseController<NetworkConfig, NetworkState> {\n  private ethQuery: any;\n\n  private internalProviderConfig: ProviderConfig = {} as ProviderConfig;\n\n  private mutex = new Mutex();\n\n  private initializeProvider(\n    type: NetworkType,\n    rpcTarget?: string,\n    chainId?: string,\n    ticker?: string,\n    nickname?: string,\n  ) {\n    switch (type) {\n      case 'kovan':\n      case 'mainnet':\n      case 'rinkeby':\n      case 'goerli':\n      case 'ropsten':\n        this.setupInfuraProvider(type);\n        break;\n      case 'localhost':\n        this.setupStandardProvider(LOCALHOST_RPC_URL);\n        break;\n      case 'rpc':\n        rpcTarget && this.setupStandardProvider(rpcTarget, chainId, ticker, nickname);\n        break;\n    }\n  }\n\n  private refreshNetwork() {\n    this.update({ network: 'loading' });\n    const { rpcTarget, type, chainId, ticker } = this.state.provider;\n    this.initializeProvider(type, rpcTarget, chainId, ticker);\n    this.lookupNetwork();\n  }\n\n  private registerProvider() {\n    this.provider.on('error', this.verifyNetwork.bind(this));\n    this.ethQuery = new EthQuery(this.provider);\n  }\n\n  private setupInfuraProvider(type: NetworkType) {\n    const infuraProvider = createInfuraProvider({ network: type, projectId: this.config.infuraProjectId });\n    const infuraSubprovider = new Subprovider(infuraProvider);\n    const config = {\n      ...this.internalProviderConfig,\n      ...{\n        dataSubprovider: infuraSubprovider,\n        engineParams: {\n          blockTrackerProvider: infuraProvider,\n          pollingInterval: 12000,\n        },\n      },\n    };\n    this.updateProvider(createMetamaskProvider(config));\n  }\n\n  private setupStandardProvider(rpcTarget: string, chainId?: string, ticker?: string, nickname?: string) {\n    const config = {\n      ...this.internalProviderConfig,\n      ...{\n        chainId,\n        engineParams: { pollingInterval: 12000 },\n        nickname,\n        rpcUrl: rpcTarget,\n        ticker,\n      },\n    };\n    this.updateProvider(createMetamaskProvider(config));\n  }\n\n  private updateProvider(provider: any) {\n    this.safelyStopProvider(this.provider);\n    this.provider = provider;\n    this.registerProvider();\n  }\n\n  private safelyStopProvider(provider: any) {\n    setTimeout(() => {\n      provider && provider.stop();\n    }, 500);\n  }\n\n  private verifyNetwork() {\n    this.state.network === 'loading' && this.lookupNetwork();\n  }\n\n  /**\n   * Name of this controller used during composition\n   */\n  name = 'NetworkController';\n\n  /**\n   * Ethereum provider object for the current network\n   */\n  provider: any;\n\n  /**\n   * Creates a NetworkController instance\n   *\n   * @param config - Initial options used to configure this controller\n   * @param state - Initial state to set on this controller\n   */\n  constructor(config?: Partial<NetworkConfig>, state?: Partial<NetworkState>) {\n    super(config, state);\n    this.defaultState = {\n      network: 'loading',\n      provider: { type: 'mainnet', chainId: '1' },\n    };\n    this.initialize();\n  }\n\n  /**\n   * Sets a new configuration for web3-provider-engine\n   *\n   * @param providerConfig - web3-provider-engine configuration\n   */\n  set providerConfig(providerConfig: ProviderConfig) {\n    this.internalProviderConfig = providerConfig;\n    const { type, rpcTarget, chainId, ticker, nickname } = this.state.provider;\n    this.initializeProvider(type, rpcTarget, chainId, ticker, nickname);\n    this.registerProvider();\n    this.lookupNetwork();\n  }\n\n  /**\n   * Refreshes the current network code\n   */\n  async lookupNetwork() {\n    /* istanbul ignore if */\n    if (!this.ethQuery || !this.ethQuery.sendAsync) {\n      return;\n    }\n    const releaseLock = await this.mutex.acquire();\n    this.ethQuery.sendAsync({ method: 'net_version' }, (error: Error, network: string) => {\n      this.update({ network: error ? /* istanbul ignore next*/ 'loading' : network });\n      releaseLock();\n    });\n  }\n\n  /**\n   * Convenience method to update provider network type settings\n   *\n   * @param type - Human readable network name\n   */\n  setProviderType(type: NetworkType) {\n    const { rpcTarget, chainId, nickname, ...providerState } = this.state.provider;\n    this.update({\n      provider: {\n        ...providerState,\n        ...{ type, ticker: 'ETH', chainId: NetworksChainId[type] },\n      },\n    });\n    this.refreshNetwork();\n  }\n\n  /**\n   * Convenience method to update provider RPC settings\n   *\n   * @param rpcTarget - RPC endpoint URL\n   * @param chainId - Network ID as per EIP-155\n   * @param ticker? - Currency ticker\n   * @param nickname? - Personalized network name\n   */\n  setRpcTarget(rpcTarget: string, chainId: string, ticker?: string, nickname?: string) {\n    this.update({\n      provider: {\n        ...this.state.provider,\n        ...{ type: 'rpc', ticker, rpcTarget, chainId, nickname },\n      },\n    });\n    this.refreshNetwork();\n  }\n}\n\nexport default NetworkController;\n"]}